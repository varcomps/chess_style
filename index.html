<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHESS RTS: APOGEE</title>
    <style>
        /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –ò –¶–í–ï–¢–ê --- */
        :root { 
            --bg-deep: #050505; 
            --sq-light: #b8c0c4; 
            --sq-dark: #6e7f8a;
            --rows: 8; 
            --cols: 8;
            --accent: #f1c40f; /* –ó–û–õ–û–¢–û–ô */
            --accent-glow: rgba(241, 196, 15, 0.6);
            --danger: #e74c3c;
            --menu-bg: rgba(16, 20, 24, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --tier-1: #bdc3c7;
            --tier-2: #2ecc71;
            --tier-3: #00d2d3;
            
            /* –†–ê–ó–ú–ï–† –ö–õ–ï–¢–ö–ò - –ê–î–ê–ü–¢–ò–í–ù–´–ô */
            --sq-size: min(calc((100vw - 20px) / var(--cols)), calc((85vh - 120px) / var(--rows)));
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            color: white; 
            display: flex; flex-direction: column; align-items: center; 
            margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw;
            user-select: none; -webkit-user-select: none;
            touch-action: none; 
        }
        
        /* –§–û–ù–û–í–´–ô –®–£–ú (–ö–û–°–ú–û–°) */
        body::before {
            content: "";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(white 1px, transparent 1px),
                radial-gradient(rgba(255,255,255,0.5) 1px, transparent 1px);
            background-size: 50px 50px, 100px 100px;
            background-position: 0 0, 25px 25px;
            opacity: 0.1; z-index: -1;
        }

        #game-layout { 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            width: 100%; 
            height: 100%; 
        }

        /* --- UI –ü–ê–ù–ï–õ–ò (–°–¢–ï–ö–õ–û) --- */
        .ui { 
            position: absolute; top: 15px; z-index: 100;
            background: var(--menu-bg); padding: 8px 20px; 
            border-radius: 20px; text-align: center; 
            border: 1px solid var(--glass-border); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; gap: 8px; align-items: center;
            max-width: 95%; width: fit-content;
            transition: all 0.3s ease;
        }

        #status { 
            font-size: 1.1em; color: var(--accent); font-weight: 800; letter-spacing: 1px; text-transform: uppercase;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.3);
        }
        
        #resource-panel {
            display: none; flex-wrap: wrap; justify-content: center; gap: 12px;
            margin-top: 5px; padding: 5px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .build-mode #resource-panel { display: flex; animation: slideDown 0.3s forwards; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .res-item { display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 0.85em; }
        /* –¶–í–ï–¢–ê –†–ï–°–£–†–°–û–í –° –Ø–†–ö–ò–ú –°–í–ï–ß–ï–ù–ò–ï–ú */
        .res-wood { color: #9b59b6; } .res-stone { color: #bdc3c7; }
        .res-metal { color: #f39c12; } .res-cedar { color: #d35400; }
        .res-paper { color: #f1c40f; } .res-food { color: #2ecc71; }
        .res-gem { color: #00d2d3; text-shadow: 0 0 8px rgba(0, 210, 211, 0.6); }
        .res-coal { color: #95a5a6; } .res-poly { color: #e056fd; text-shadow: 0 0 8px rgba(224, 86, 253, 0.6); }

        .limit-reached { color: #e74c3c !important; text-shadow: 0 0 5px red; animation: pulseRed 1.5s infinite; }
        @keyframes pulseRed { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        button { 
            padding: 10px 20px; background: #27ae60; color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-weight: 700; 
            transition: all 0.2s; text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            touch-action: manipulation;
        }
        button:active { transform: scale(0.96); }

        /* --- –ö–ù–û–ü–ö–ê –°–¢–†–û–ô–ö–ò (–ù–û–í–´–ô –î–ò–ó–ê–ô–ù) --- */
        #toggle-build-btn {
            position: absolute; bottom: 25px; left: 20px;
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid var(--accent);
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.2), inset 0 0 10px rgba(241, 196, 15, 0.1);
            color: var(--accent);
            font-size: 30px; z-index: 160; 
            display: none; /* Flex –Ω–∞ –º–æ–±–∏–ª–∫–µ */
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* –ü–£–õ–¨–°–ê–¶–ò–Ø –ö–ù–û–ü–ö–ò */
        #toggle-build-btn::after {
            content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%; border: 2px solid var(--accent); opacity: 0;
            animation: ripple 2s infinite;
        }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.4); opacity: 0; } }

        .build-mode #toggle-build-btn { 
            background: var(--danger); border-color: #c0392b; color: white;
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.5);
            transform: rotate(135deg) scale(1.1); 
            bottom: 180px; /* –ü–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –º–µ–Ω—é */
        }

        /* --- –ú–ï–ù–Æ –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–ê --- */
        #build-menu-container {
            position: absolute; left: 20px; top: 50%;
            transform: translateY(-50%) translateX(-250%);
            width: 150px;
            background: var(--menu-bg); border-radius: 16px; 
            padding: 12px;
            display: flex; flex-direction: column; gap: 10px;
            border: 1px solid var(--glass-border); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            backdrop-filter: blur(15px); z-index: 150;
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            max-height: 80vh;
        }
        .build-mode #build-menu-container { transform: translateY(-50%) translateX(0); }

        .menu-tabs { display: flex; flex-direction: column; gap: 6px; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;}
        .tab-btn {
            background: rgba(255,255,255,0.03); border: 1px solid transparent;
            color: #7f8c8d; padding: 10px 0; width: 100%; text-align: center;
            border-radius: 8px; cursor: pointer; font-size: 0.75em; font-weight: bold; letter-spacing: 1px;
            transition: 0.2s;
        }
        .tab-btn.active { background: rgba(241, 196, 15, 0.1); color: var(--accent); border-color: var(--accent); text-shadow: 0 0 10px rgba(241, 196, 15, 0.4); }

        #build-list {
            display: flex; flex-direction: column; 
            overflow-y: auto; overflow-x: hidden;
            padding: 5px 2px; flex-grow: 1; 
        }

        .build-group { display: none; flex-direction: column; gap: 12px; align-items: center; width: 100%; }
        .build-group.active { display: flex; animation: fadeIn 0.3s; }

        .build-item {
            width: 60px; height: 60px; background: rgba(255,255,255,0.03);
            border-radius: 14px; display: flex; align-items: center; justify-content: center;
            cursor: grab; transition: 0.2s; position: relative; border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0;
            touch-action: none;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .build-item:active { transform: scale(0.92); background: rgba(255,255,255,0.1); }
        
        .build-item::after { 
            position: absolute; top: -6px; right: -6px; 
            font-size: 10px; padding: 2px 5px; border-radius: 6px; font-weight: 900; color: #000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .t1-item { border-color: var(--tier-1); } .t1-item::after { content: 'I'; background: var(--tier-1); }
        .t2-item { border-color: var(--tier-2); box-shadow: inset 0 0 10px rgba(46, 204, 113, 0.1); } .t2-item::after { content: 'II'; background: var(--tier-2); }
        .t3-item { border-color: var(--tier-3); box-shadow: inset 0 0 10px rgba(0, 210, 211, 0.1); } .t3-item::after { content: 'III'; background: var(--tier-3); }
        .demolish-item { border-color: #e74c3c !important; background: rgba(231, 76, 60, 0.1) !important; }
        .demolish-item::after { content: 'X' !important; background: #e74c3c !important; color: white !important; }
        .build-item .icon { font-size: 30px; pointer-events: none; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        /* --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø --- */
        @media (max-width: 768px) {
            #toggle-build-btn { display: flex; }

            #build-menu-container {
                left: 0; top: auto; bottom: 0;
                transform: translateY(110%);
                width: 100%; box-sizing: border-box;
                border-radius: 24px 24px 0 0;
                flex-direction: column; 
                padding: 15px 0 30px 0;
                max-height: 240px;
                background: #151515;
                border: none; border-top: 2px solid var(--accent);
                box-shadow: 0 -10px 50px rgba(0,0,0,0.9);
            }
            .build-mode #build-menu-container { transform: translateY(0); }

            .menu-tabs { 
                flex-direction: row; width: 100%; border-bottom: none; 
                padding: 0 15px 10px 15px; box-sizing: border-box;
                justify-content: space-between; gap: 10px;
            }
            .tab-btn { width: 32%; padding: 12px 0; background: #222; }
            
            #build-list {
                flex-direction: row; width: 100%; 
                overflow-x: auto; overflow-y: hidden;
                padding: 10px 15px; box-sizing: border-box;
                touch-action: pan-x; -webkit-overflow-scrolling: touch; 
            }
            
            .build-group { flex-direction: row; width: max-content; gap: 15px; }
            #build-list::-webkit-scrollbar { display: none; }
            .build-item { width: 70px; height: 70px; margin-right: 5px; }
            #forge-ui { bottom: 200px; right: 10px; }
            .ui { font-size: 0.9em; width: 92%; top: 10px; }
        }

        /* --- –î–û–°–ö–ê (–ò–°–ü–†–ê–í–õ–ï–ù–ê) --- */
        #board-wrapper { 
            transition: margin 0.3s; 
            display: flex; align-items: center; justify-content: center; 
            padding: 10px; /* –û—Ç—Å—Ç—É–ø —á—Ç–æ–±—ã —Ç–µ–Ω–∏ –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∏—Å—å */
        }
        #board { 
            display: grid; 
            grid-template-columns: repeat(var(--cols), var(--sq-size)); 
            grid-template-rows: repeat(var(--rows), var(--sq-size)); 
            position: relative; 
            background: #000; /* –ß–ï–†–ù–ê–Ø –ü–û–î–õ–û–ñ–ö–ê –°–ö–†–´–í–ê–ï–¢ –©–ï–õ–ò */
            border: 4px solid #333; 
            border-radius: 6px;
            box-shadow: 0 0 50px rgba(0,0,0,1); 
            transition: transform 0.5s ease, border-color 0.3s;
            touch-action: none;
        }
        
        /* –°–í–ï–ß–ï–ù–ò–ï –í –†–ï–ñ–ò–ú–ï –°–¢–†–û–ô–ö–ò */
        .build-mode #board:not(.expanded) { 
            border-color: var(--accent); 
            box-shadow: 0 0 40px rgba(243, 156, 18, 0.2); 
        }
        
        #board.expanded { 
            background: transparent; 
            border: none; 
            box-shadow: none; 
            /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –¥–æ—Å–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ */
        }
        
        .square { 
            width: var(--sq-size); height: var(--sq-size); 
            display: flex; justify-content: center; align-items: center; 
            position: relative; box-sizing: border-box; 
            background-color: #222; 
        }
        .square.light { background-color: var(--sq-light); }
        .square.dark { background-color: var(--sq-dark); }
        
        /* --- –ö–†–ê–°–ò–í–´–ô –¢–£–ú–ê–ù –í–û–ô–ù–´ (–°–ï–¢–ö–ê) --- */
        .square.fog {
            background-color: #0b0b0b !important;
            /* –°–µ—Ç–∫–∞ */
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%;
            border: 1px solid rgba(0,0,0,0.5); /* –ï–¥–≤–∞ –∑–∞–º–µ—Ç–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã */
            box-shadow: inset 0 0 20px #000;
            z-index: 1;
        }
        /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–ª–æ—Å–∫—É –µ—Å–ª–∏ –±—ã–ª–∞ */
        .square.fog::before { display: none; }

        .square.drag-over { 
            background: rgba(241, 196, 15, 0.4) !important; 
            box-shadow: inset 0 0 0 3px #f1c40f; 
        }
        
        /* –ê–ù–ò–ú–ê–¶–ò–Ø POP-IN */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .square.growing { 
            transform-origin: center; 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
            box-shadow: 0 0 10px rgba(0,255,255,0.2);
        }

        .piece { 
            width: 85%; height: 85%; background-size: contain; background-repeat: no-repeat; 
            background-position: center; cursor: grab; z-index: 10; 
            filter: drop-shadow(0 5px 3px rgba(0,0,0,0.6)); /* –¢–µ–Ω—å –¥–ª—è —Ñ–∏–≥—É—Ä */
            position: relative; touch-action: none; pointer-events: auto;
            transition: transform 0.1s;
        }
        .piece:active { transform: scale(1.1); }
        
        .piece .armor-badge {
            position: absolute; bottom: -5px; right: -5px; left: auto;
            background: #3498db; color: white; border: 2px solid #2c3e50;
            border-radius: 50%; width: 18px; height: 18px;
            font-size: 10px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; z-index: 12; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .special-piece { 
            font-size: calc(var(--sq-size) * 0.65); 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.8)); 
            pointer-events: none; z-index: 11; display: flex; justify-content: center; align-items: center;
            position: relative;
        }
        /* –ü–û–õ–û–°–ö–ê HP */
        .special-piece .hp-bar {
            position: absolute; bottom: 0; width: 120%; height: 5px; 
            background: #333; border: 1px solid #000; border-radius: 3px; overflow: hidden;
            box-shadow: 0 2px 4px black;
        }
        .special-piece .hp-val { height: 100%; background: linear-gradient(90deg, #e74c3c, #c0392b); }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-content {
            background: linear-gradient(145deg, #2c3e50, #202d3a); 
            padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.8); width: 90%; max-width: 400px;
        }
        .promo-options { display: flex; gap: 12px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
        .promo-btn {
            width: 70px; height: 70px; background: rgba(255,255,255,0.05); 
            border: 2px solid #555;
            border-radius: 12px; cursor: pointer; font-size: 28px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: 0.2s;
        }
        .promo-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        .promo-btn .cost { font-size: 10px; margin-top: 5px; color: #f1c40f; font-weight: bold;}

        .dragging-clone {
            position: fixed; width: var(--sq-size); height: var(--sq-size); pointer-events: none; z-index: 9999;
            transform: translate(-50%, -50%) scale(1.2); opacity: 0.9;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            display: flex; align-items: center; justify-content: center; 
            font-size: calc(var(--sq-size) * 0.7);
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
        }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        .hidden-btn { display: none !important; }

        #ui-tooltip {
            position: fixed; pointer-events: none; z-index: 2000;
            background: rgba(0,0,0,0.9); padding: 10px 15px; border-radius: 8px;
            border: 1px solid var(--accent); color: #ecf0f1; font-size: 13px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            display: none; white-space: nowrap; backdrop-filter: blur(4px);
        }

        #forge-ui { 
            position: absolute; bottom: 30px; right: 20px; 
            background: rgba(20, 20, 20, 0.9); border: 1px solid #e67e22; 
            padding: 12px; border-radius: 12px; z-index: 155; display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(230, 126, 34, 0.3);
            transition: bottom 0.3s;
        }
        
        #connection-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; 
            z-index: 3000; display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s; padding: 20px; box-sizing: border-box;
            background-image: radial-gradient(circle at center, #111 0%, #000 100%);
        }
        #connection-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 40px; border-radius: 30px;
            box-shadow: 0 0 100px rgba(0,0,0,1);
            text-align: center; width: 100%; max-width: 380px;
            backdrop-filter: blur(20px);
        }
        .id-display {
            background: rgba(0,0,0,0.5); padding: 15px; border-radius: 12px;
            margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #333;
        }
        .id-display strong { font-family: 'Courier New', monospace; font-size: 1.1em; color: #00d2d3; letter-spacing: 1px; }
        #peer-id {
            width: 100%; padding: 15px; background: rgba(0,0,0,0.3);
            border: 2px solid #444; border-radius: 12px; color: white;
            font-size: 1.1em; text-align: center; box-sizing: border-box; margin-bottom: 20px;
            outline: none; transition: 0.3s;
        }
        #peer-id:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(241, 196, 15, 0.2); }
        .connect-btn { 
            width: 100%; padding: 15px; font-size: 1.2em; 
            background: linear-gradient(90deg, #f39c12, #d35400); 
            box-shadow: 0 5px 20px rgba(211, 84, 0, 0.4);
        }
    </style>
</head>
<body>

<div id="ui-tooltip"></div>

<div id="toggle-build-btn" onclick="toggleBuildMode()" title="–†–ï–ñ–ò–ú –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–ê">üõ†Ô∏è</div>

<div id="forge-ui">
    <button onclick="useForge()" style="background: linear-gradient(to right, #e67e22, #d35400);">‚öíÔ∏è –ö–û–í–ê–¢–¨ (2–º–µ—Ç, 2—É–≥)</button>
</div>

<div id="academy-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color: #f1c40f; margin:0 0 15px 0;">–í–ï–†–ë–û–í–ö–ê (1 –û–î)</h2>
        <div style="margin-bottom: 15px;">
            <div style="color:#aaa; font-size:0.8em; margin-bottom:5px; text-transform:uppercase;">–°—Ç–∞–Ω–¥–∞—Ä—Ç (2 –ë—É–º–∞–≥–∏ üìú)</div>
            <div class="promo-options" id="acad-std-options"></div>
        </div>
        <div id="acad-elite-section" class="hidden">
            <div style="color:gold; font-size:0.8em; margin-bottom:5px; text-transform:uppercase;">–≠–ª–∏—Ç–∞ (5 –ë—É–º–∞–≥–∏ üìú)</div>
            <div class="promo-options" id="acad-elite-options"></div>
        </div>
        <button onclick="closeModal('academy-modal')" style="margin-top:20px; background:#c0392b; width:100%;">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<div id="promotion-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 style="color: #f1c40f; margin:0;">–í–´–ë–ï–†–ò –°–£–î–¨–ë–£</h2>
        <div class="promo-options" id="promo-options-container"></div>
    </div>
</div>

<div id="victory-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div id="victory-title" style="font-size:2.5em; font-weight:900; margin-bottom:20px; text-shadow:0 0 20px currentColor;"></div>
        <button onclick="location.reload()" style="font-size: 1.2em; padding: 15px 40px; background: #fff; color:#000;">–ï–©–Å –†–ê–ó</button>
    </div>
</div>

<div id="connection-overlay">
    <div id="connection-card">
        <div class="conn-title" style="font-size: 2.5em; font-weight:900; margin-bottom: 10px; color: #f1c40f; letter-spacing: 2px;">CHESS RTS</div>
        <div style="color: #777; margin-bottom: 25px; font-size: 0.9em;">TACTICAL WARFARE</div>
        
        <div class="id-display">
            <span style="color:#aaa; font-size:0.8em;">–¢–í–û–ô ID:</span>
            <strong id="my-id">...</strong>
            <button onclick="copyId()" style="background:none; border:none; font-size:1.2em; cursor:pointer; padding:0; box-shadow:none;">üìã</button>
        </div>
        
        <input type="text" id="peer-id" placeholder="–í–°–¢–ê–í–¨ ID –î–†–£–ì–ê">
        <button class="connect-btn" onclick="connectToPeer()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø ‚öîÔ∏è</button>
        <div id="conn-status" style="margin-top:15px; font-size:0.8em; color:#777;"></div>
    </div>
</div>

<div class="ui">
    <div id="status">–û–ñ–ò–î–ê–ù–ò–ï...</div>
    
    <div id="resource-panel">
        <div class="res-item res-wood"><span>ü™µ</span> <span id="res-wood-val">0</span>/5</div>
        <div class="res-item res-stone"><span>üß±</span> <span id="res-stone-val">0</span>/5</div>
        <div class="res-item res-metal"><span>‚õìÔ∏è</span> <span id="res-metal-val">0</span>/5</div>
        <div class="res-item res-cedar"><span>üå≤</span> <span id="res-cedar-val">0</span>/5</div>
        <div class="res-item res-paper"><span>üìú</span> <span id="res-paper-val">0</span>/5</div>
        <div class="res-item res-food"><span>üçû</span> <span id="res-food-val">0</span>/5</div>
        <div class="res-item res-gem"><span>üíé</span> <span id="res-gem-val">0</span>/5</div>
        <div class="res-item res-coal"><span>‚ö´</span> <span id="res-coal-val">0</span>/5</div>
        <div class="res-item res-poly"><span>üß™</span> <span id="res-poly-val">0</span>/5</div>
    </div>

    <button id="btn-apogee" onclick="activateApogee()" style="display:none; background: linear-gradient(135deg, #8e44ad, #c0392b); margin-top:8px; width:100%; box-shadow: 0 0 15px rgba(142, 68, 173, 0.5);">‚òÑÔ∏è –ê–ü–û–ì–ï–ô</button>
</div>

<div id="game-layout">
    <div id="build-menu-container">
        <div class="menu-tabs">
            <div class="tab-btn active" id="tab-btn-build" onclick="switchTab('build')">–°–¢–†–û–ô</div>
            <div class="tab-btn" id="tab-btn-upgrade" onclick="switchTab('upgrade')">–£–õ–£–ß–®</div>
            <div class="tab-btn" id="tab-btn-elite" onclick="switchTab('elite')">–≠–õ–ò–¢–ê</div>
        </div>
        
        <div id="build-list">
            <div class="build-group group-build active">
                <div class="build-item demol-item" data-type="demolish" data-label="–°–ù–û–°" data-cost="1 –û–î" onpointerdown="onSidebarPointerDown(event, 'demolish')"><span class="icon">üß®</span></div>
                <div id="btn-build-hq" class="build-item t1-item" data-type="hq" data-label="–®–¢–ê–ë" data-cost="4–∫, 2–¥ | 1 –û–î" onpointerdown="onSidebarPointerDown(event, 'hq')"><span class="icon">üè∞</span></div>
                <div class="build-item t1-item" data-type="fortress" data-label="–°–¢–ï–ù–ê" data-cost="4 –ö–∞–º–Ω—è | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'fortress')"><span class="icon">üß±</span></div>
                <div class="build-item t1-item" data-type="camp" data-label="–õ–ê–ì–ï–†–¨" data-cost="3–¥, 1–æ–¥ | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'camp')"><span class="icon">‚õ∫</span></div>
                <div class="build-item t1-item" data-type="lumber" data-label="–õ–ï–°–û–ü–û–í–ê–õ" data-cost="1 –û–î" onpointerdown="onSidebarPointerDown(event, 'lumber')"><span class="icon">ü™ì</span></div>
                <div class="build-item t1-item" data-type="mine" data-label="–†–£–î–ù–ò–ö" data-cost="1 –û–î" onpointerdown="onSidebarPointerDown(event, 'mine')"><span class="icon">‚õèÔ∏è</span></div>
                <div class="build-item t1-item" data-type="farm" data-label="–§–ï–†–ú–ê" data-cost="2–¥ | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'farm')"><span class="icon">üåæ</span></div>
                <div class="build-item t1-item" data-type="academy" data-label="–ê–ö–ê–î–ï–ú–ò–Ø" data-cost="2–∫, 2–¥ | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'academy')"><span class="icon">üéì</span></div>
                <div class="build-item t1-item" data-type="papermill" data-label="–ü–ï–ß–ê–¢–ù–Ø" data-cost="2–∫, 2–¥ | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'papermill')"><span class="icon">üìú</span></div>
            </div>

            <div class="build-group group-upgrade">
                <div class="build-item demol-item" data-type="demolish" data-label="–°–ù–û–°" data-cost="1 –û–î" onpointerdown="onSidebarPointerDown(event, 'demolish')"><span class="icon">üß®</span></div>
                <div class="build-item t2-item" data-type="lumber_t2" data-label="–ê–ü–ì–†–ï–ô–î: –õ–ï–°–û–ü–ò–õ–ö–ê T2" data-cost="4–¥, 2–∫ | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'lumber_t2')"><span class="icon">üå≤</span></div>
                <div class="build-item t2-item" data-type="mine_t2" data-label="–ê–ü–ì–†–ï–ô–î: –®–ê–•–¢–ê T2" data-cost="4–∫, 2–¥ | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'mine_t2')"><span class="icon">üèóÔ∏è</span></div>
                <div class="build-item t2-item" data-type="academy_t2" data-label="–ê–ü–ì–†–ï–ô–î: –£–ù–ò–í–ï–†–°–ò–¢–ï–¢" data-cost="2–∫, 2–¥, 2–∫–µ–¥—Ä, 2–º–µ—Ç | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'academy_t2')"><span class="icon">üèõÔ∏è</span></div>
                <div class="build-item t2-item" data-type="fortress_t2" data-label="–ê–ü–ì–†–ï–ô–î: –ë–ê–°–¢–ò–û–ù" data-cost="4–∫, 2–º–µ—Ç | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'fortress_t2')"><span class="icon">üõ°Ô∏è</span></div>
                <div class="build-item t2-item" data-type="furnace" data-label="–ü–ï–ß–¨" data-cost="3–∫, 1–º–µ—Ç | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'furnace')"><span class="icon">üî•</span></div>
            </div>

            <div class="build-group group-elite">
                <div class="build-item demol-item" data-type="demolish" data-label="–°–ù–û–°" data-cost="1 –û–î" onpointerdown="onSidebarPointerDown(event, 'demolish')"><span class="icon">üß®</span></div>
                <div class="build-item t3-item" data-type="lumber_t3" data-label="–ó–ê–í–û–î –ü–û–õ–ò–ú–ï–†–û–í" data-cost="4–¥, 2–∫, 2–º–µ—Ç, 2–∫–µ–¥—Ä | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'lumber_t3')"><span class="icon">üß¨</span></div>
                <div class="build-item t3-item" data-type="mine_t3" data-label="–ê–õ–ú–ê–ó–ù–´–ô –ë–£–†" data-cost="2–¥, 4–∫, 2–º–µ—Ç, 2–∫–µ–¥—Ä | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'mine_t3')"><span class="icon">üíé</span></div>
                <div class="build-item t3-item" data-type="fortress_t3" data-label="–ê–ü–ì–†–ï–ô–î: –¶–ò–¢–ê–î–ï–õ–¨" data-cost="5–∫, 5–º–µ—Ç | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'fortress_t3')"><span class="icon">üèØ</span></div>
                <div class="build-item t3-item" data-type="forge" data-label="–ö–£–ó–ù–Ø –ë–û–ì–û–í" data-cost="5–¥, 5–º–µ—Ç, 5—É–≥, 5–∞–ª–º | 2 –û–î" onpointerdown="onSidebarPointerDown(event, 'forge')"><span class="icon">‚öíÔ∏è</span></div>
            </div>
        </div>
    </div>

    <div id="board-wrapper">
        <div id="board"></div>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    /* --- CONFIG --- */
    const PIECE_URLS = {
        wk: 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg',
        wq: 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
        wr: 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
        wb: 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
        wn: 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
        wp: 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
        bk: 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg',
        bq: 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
        br: 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
        bb: 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
        bn: 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
        bp: 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg'
    };

    const BUILDINGS = ['hq', 'camp', 'academy', 'academy_t2', 'lumber', 'lumber_t2', 'lumber_t3', 'mine', 'mine_t2', 'mine_t3', 'papermill', 'farm', 'house', 'fortress', 'fortress_t2', 'fortress_t3', 'forge', 'furnace'];
    const T2_BUILDINGS = ['academy_t2', 'lumber_t2', 'mine_t2', 'fortress_t2', 'furnace'];
    const T3_BUILDINGS = ['lumber_t3', 'mine_t3', 'fortress_t3', 'forge']; 
    
    const BUILDING_ICONS = { 
        hq: 'üè∞', camp: '‚õ∫', 
        academy: 'üéì', academy_t2: 'üèõÔ∏è', 
        lumber: 'ü™ì', lumber_t2: 'üå≤', lumber_t3: 'üß¨', 
        mine: '‚õèÔ∏è', mine_t2: 'üèóÔ∏è', mine_t3: 'üíé',
        papermill: 'üìú', farm: 'üåæ',
        house: 'üè†', demolish: 'üß®',
        fortress: 'üß±', fortress_t2: 'üõ°Ô∏è', fortress_t3: 'üèØ',
        forge: '‚öíÔ∏è', furnace: 'üî•'
    };

    const BUILDING_COSTS = {
        hq: { wood: 2, stone: 4, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        camp: { wood: 3, stone: 0, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        lumber: { wood: 0, stone: 0, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        mine: { wood: 0, stone: 0, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        papermill: { wood: 2, stone: 2, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        academy: { wood: 2, stone: 2, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        farm: { wood: 2, stone: 0, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        lumber_t2: { wood: 4, stone: 2, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        mine_t2: { wood: 2, stone: 4, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        academy_t2: { wood: 2, stone: 2, metal: 2, cedar: 2, paper: 0, food: 0, gem: 0, coal: 0 },
        furnace: { wood: 0, stone: 3, metal: 1, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        lumber_t3: { wood: 4, stone: 2, metal: 2, cedar: 2, paper: 0, food: 0, gem: 0, coal: 0 },
        mine_t3: { wood: 2, stone: 4, metal: 2, cedar: 2, paper: 0, food: 0, gem: 0, coal: 0 },
        fortress: { wood: 0, stone: 4, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        fortress_t2: { wood: 0, stone: 4, metal: 2, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        fortress_t3: { wood: 0, stone: 5, metal: 5, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 },
        forge: { wood: 5, stone: 0, metal: 5, cedar: 0, paper: 0, food: 0, gem: 5, coal: 5 },
        demolish: { wood: 0, stone: 0, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0 }
    };

    const BUILDING_LIMITS = { hq: 1, camp: 1, academy: 1, papermill: 1, lumber: 2, mine: 2, farm: 2, fortress: 4, forge: 1, furnace: 2 };
    const FORTRESS_HP = { fortress: 2, fortress_t2: 4, fortress_t3: 8 };

    let peer = new Peer(null, {
        debug: 2,
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' }
            ]
        }
    });

    let conn = null;
    let playerColor = null;
    let isBuildMode = false;
    let actionsLeft = 0;
    let gameOver = false;
    let isExpanded = false; 
    let expansionAnimationDone = false;
    let rows = 8, cols = 8;
    let selectedPiece = null; 
    
    let myResources = { wood: 0, stone: 0, metal: 0, cedar: 0, paper: 0, food: 0, gem: 0, coal: 0, polymer: 0 };
    let state = Array(8).fill(null).map(() => Array(8).fill(null));

    let pendingMove = null;
    let pendingAcademy = null; 
    
    const dragState = {
        started: false, cloneEl: null, from: null, isBuildingDrag: false,
        pointerId: null, startX: 0, startY: 0, lastHover: null
    };

    function toggleBuildMode() {
        if(actionsLeft <= 0 && !isBuildMode) return; 
        isBuildMode = !isBuildMode;
        const btn = document.getElementById('toggle-build-btn');
        btn.innerHTML = isBuildMode ? '‚ùå' : 'üõ†Ô∏è';
        updateUI(); render();
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-btn-${tab}`).classList.add('active');
        document.querySelectorAll('.build-group').forEach(g => g.classList.remove('active'));
        document.querySelector(`.group-${tab}`).classList.add('active');
    }

    function copyId() {
        const id = document.getElementById('my-id').innerText;
        if (id && id !== '...') navigator.clipboard.writeText(id).then(() => alert("ID –°–ö–û–ü–ò–†–û–í–ê–ù!"));
    }

    /* TOOLTIPS */
    const tooltipEl = document.getElementById('ui-tooltip');
    document.querySelectorAll('.build-item').forEach(item => {
        item.addEventListener('mouseenter', e => showTooltip(e, item));
        item.addEventListener('mousemove', moveTooltip);
        item.addEventListener('mouseleave', () => { tooltipEl.style.display = 'none'; });
        item.addEventListener('touchstart', (e) => {
            showTooltip(e.touches[0], item);
            setTimeout(() => tooltipEl.style.display = 'none', 3000);
        }, {passive: true});
    });

    function showTooltip(e, item) {
        const label = item.getAttribute('data-label');
        const cost = item.getAttribute('data-cost');
        if(label) {
            tooltipEl.style.display = 'block';
            tooltipEl.innerHTML = `<strong>${label}</strong><br><span style="color:#f1c40f">${cost}</span>`;
            moveTooltip(e);
        }
    }

    function moveTooltip(e) {
        const x = e.clientX || e.pageX;
        const y = e.clientY || e.pageY;
        tooltipEl.style.left = (x + 15) + 'px';
        tooltipEl.style.top = (y - 50) + 'px'; 
    }

    function initBoard() {
        const layout = ['r','n','b','q','k','b','n','r'];
        for(let i=0; i<8; i++) {
            state[0][i] = { type: layout[i], color: 'b', moved: false, armor: 0 };
            state[1][i] = { type: 'p', color: 'b', moved: false, armor: 0 };
            state[6][i] = { type: 'p', color: 'w', moved: false, armor: 0 };
            state[7][i] = { type: layout[i], color: 'w', moved: false, armor: 0 };
        }
        render();
    }

    function isFog(r, c) {
        if (!isExpanded) return false;
        return (r >= 4 && r <= 11);
    }
    
    function isUpgradedUnit(piece) {
        return piece && piece.type.endsWith('_2');
    }

    function render() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        document.documentElement.style.setProperty('--rows', rows);
        document.documentElement.style.setProperty('--cols', cols);

        if (isExpanded) boardEl.classList.add('expanded');
        
        const rangeR = playerColor === 'b' ? [...Array(rows).keys()].reverse() : [...Array(rows).keys()];
        const rangeC = [...Array(cols).keys()];

        const forgeUI = document.getElementById('forge-ui');
        let forgeActive = false;
        
        rangeR.forEach(r => {
            rangeC.forEach(c => {
                const square = document.createElement('div');
                let isDark = (r + c) % 2 !== 0;
                square.className = `square ${isDark ? 'dark' : 'light'}`;
                if (isFog(r, c)) square.classList.add('fog');
                
                // --- –ê–ù–ò–ú–ê–¶–ò–Ø ---
                if (isExpanded && r >= 4 && r < 12 && !expansionAnimationDone) { 
                    square.classList.add('growing');
                    const dist = Math.abs(r - 7.5) + Math.abs(c - 3.5);
                    square.style.animationDelay = `${dist * 0.05}s`; 
                }

                const p = state[r][c];
                
                if(p) {
                    const pDiv = document.createElement('div');
                    
                    if (p.type === 'forge') {
                        pDiv.className = 'special-piece t3-building';
                        pDiv.innerHTML = BUILDING_ICONS['forge'];
                        pDiv.style.textShadow = '0 0 15px #e67e22';
                        square.appendChild(pDiv);
                    }
                    else if (BUILDINGS.includes(p.type)) {
                        pDiv.className = 'special-piece';
                        if (T2_BUILDINGS.includes(p.type)) pDiv.classList.add('t2-building');
                        if (T3_BUILDINGS.includes(p.type)) pDiv.classList.add('t3-building');
                        if (p.type === 'house') pDiv.classList.add('settlement');
                        
                        pDiv.innerHTML = BUILDING_ICONS[p.type] || '?';
                        
                        if (p.type.startsWith('fortress')) {
                            const max = FORTRESS_HP[p.type] || 2;
                            const cur = p.hp !== undefined ? p.hp : max;
                            const bar = document.createElement('div');
                            bar.className = 'hp-bar';
                            const fill = document.createElement('div');
                            fill.className = 'hp-val';
                            fill.style.width = (cur / max * 100) + '%';
                            bar.appendChild(fill);
                            pDiv.appendChild(bar);
                        }

                        let glow = 'rgba(0,0,0,0.5)';
                        if (p.color === 'w') glow = 'rgba(255,255,255,0.7)';
                        else if (p.color === 'b') glow = 'rgba(0,0,0,0.7)';
                        
                        pDiv.style.textShadow = `0 0 10px ${glow}`;
                        
                        if (p.type === 'camp' && p.color === playerColor) {
                            pDiv.style.cursor = 'pointer';
                            pDiv.addEventListener('pointerdown', e => onCampClick(e, r, c));
                        }
                        square.appendChild(pDiv);
                    } else {
                        pDiv.className = 'piece';
                        const baseType = p.type.replace('_2', '');
                        pDiv.style.backgroundImage = `url(${PIECE_URLS[p.color + baseType]})`;
                        if (isUpgradedUnit(p)) pDiv.classList.add('upgraded');
                        
                        if (p.armor > 0) {
                            const badge = document.createElement('div');
                            badge.className = 'armor-badge';
                            badge.innerText = p.armor;
                            pDiv.appendChild(badge);
                        }
                        
                        pDiv.addEventListener('pointerdown', e => onPiecePointerDown(e, r, c));
                        square.appendChild(pDiv);

                        if (p.onForge && p.color === playerColor) {
                            selectedPiece = { r, c }; 
                            forgeActive = true;
                            square.style.boxShadow = "inset 0 0 20px #e67e22";
                        }
                    }
                } 
                boardEl.appendChild(square);
            });
        });

        forgeUI.style.display = forgeActive ? 'block' : 'none';
        
        const els = {
            wood: document.getElementById('res-wood-val'),
            stone: document.getElementById('res-stone-val'),
            metal: document.getElementById('res-metal-val'),
            cedar: document.getElementById('res-cedar-val'),
            paper: document.getElementById('res-paper-val'),
            food: document.getElementById('res-food-val'),
            gem: document.getElementById('res-gem-val'),
            coal: document.getElementById('res-coal-val'),
            polymer: document.getElementById('res-poly-val')
        };
        
        for (let k in els) {
            if(els[k]) {
                els[k].innerText = myResources[k];
                const parent = els[k].parentElement;
                if (myResources[k] >= 5) parent.classList.add('limit-reached');
                else parent.classList.remove('limit-reached');
            }
        }
    }

    function useForge() {
        if (!selectedPiece) return;
        const p = state[selectedPiece.r][selectedPiece.c];
        if (!p || !p.onForge) return;
        
        if (myResources.metal < 2 || myResources.coal < 2) {
            alert("–ù–£–ñ–ù–û 2 –ú–ï–¢–ê–õ–õ–ê –ò 2 –£–ì–õ–Ø!");
            return;
        }

        myResources.metal -= 2;
        myResources.coal -= 2;
        p.armor = (p.armor || 0) + 1;
        
        conn.send({ type: 'forge_armor', r: selectedPiece.r, c: selectedPiece.c });
        render(); updateUI();
    }

    function activateApogee() {
        if (isExpanded) return;
        document.getElementById('btn-apogee').style.display = 'none';
        conn.send({ type: 'apogee_trigger' });
        triggerExpansion();
    }

    function triggerExpansion() {
        if (isExpanded) return;
        document.getElementById('btn-apogee').style.display = 'none';
        
        const newState = Array(16).fill(null).map(() => Array(8).fill(null));
        
        for(let r=0; r<8; r++) {
            for(let c=0; c<8; c++) {
                if (state[r][c]) {
                    if (r < 4) newState[r][c] = state[r][c];
                    else newState[r + 8][c] = state[r][c]; 
                }
            }
        }
        
        state = newState; rows = 16; cols = 8;
        isExpanded = true;
        render(); updateUI();
        setTimeout(() => { expansionAnimationDone = true; }, 2000);
    }

    function hasSpecial(color, type) { return state.flat().some(p => p && p.type === type && p.color === color); }
    
    function getBuildingCount(baseType) {
        let count = 0;
        state.flat().forEach(p => {
            if (p && p.color === playerColor) {
                const t = p.type;
                if (t === baseType || t.startsWith(baseType + '_')) count++;
                if (baseType === 'forge' && p.onForge) count++;
            }
        });
        return count;
    }

    function buildSomething(r, c, type) {
        let apCost = 2;
        if (type === 'lumber' || type === 'mine' || type === 'demolish' || type === 'hq') apCost = 1;

        if (type === 'demolish') {
            if (!state[r][c] || state[r][c].color !== playerColor) { alert("–ù–ï–õ–¨–ó–Ø –°–ù–û–°–ò–¢–¨."); return; }
            if (actionsLeft < apCost) { alert(`–ù–£–ñ–ù–û ${apCost} –û–î.`); return; }
            
            if (state[r][c].onForge) {
                state[r][c].onForge = false;
            } else {
                state[r][c] = null;
            }
            
            actionsLeft -= apCost;
            conn.send({ type: 'demolish', r, c, isLast: (actionsLeft<=0) });
            updateUI(); render();
            return;
        }

        const costs = BUILDING_COSTS[type];
        
        if (type.endsWith('_t2') || type.endsWith('_t3')) {
            let baseType = '';
            let requiredType = '';
            
            if (type.endsWith('_t2')) {
                baseType = type.replace('_t2', '');
                requiredType = baseType; 
            } else {
                baseType = type.replace('_t3', '');
                requiredType = baseType + '_t2'; 
            }
            
            const target = state[r][c];
            if (!target || target.type !== requiredType || target.color !== playerColor) {
                alert(`–£–õ–£–ß–®–ï–ù–ò–ï ${type} –ú–û–ñ–ù–û –°–¢–ê–í–ò–¢–¨ –¢–û–õ–¨–ö–û –ù–ê ${requiredType}!`);
                return;
            }
            if (actionsLeft < apCost) return alert(`–ù–£–ñ–ù–û ${apCost} –û–î.`);
            if (!checkResources(costs)) return;
            
            payResources(costs);
            state[r][c].type = type;
            if (type.startsWith('fortress')) state[r][c].hp = FORTRESS_HP[type];
            
            actionsLeft -= apCost;
            conn.send({ type: 'upgrade', r, c, newType: type, isLast: (actionsLeft<=0) });
            updateUI(); render();
            return;
        }

        if (state[r][c]) return; 
        if (actionsLeft < apCost) return alert(`–ù–£–ñ–ù–û ${apCost} –û–î.`);
        
        const limitType = type;
        if (BUILDING_LIMITS[limitType] && getBuildingCount(limitType) >= BUILDING_LIMITS[limitType]) {
            alert(`–õ–ò–ú–ò–¢ –ü–û–°–¢–†–û–ï–ö (${type}) –î–û–°–¢–ò–ì–ù–£–¢!`);
            return;
        }

        if (!checkResources(costs)) return;

        payResources(costs);
        actionsLeft -= apCost;
        
        let newObj = { type: type, color: playerColor };
        if (type === 'fortress') newObj.hp = FORTRESS_HP['fortress'];
        
        state[r][c] = newObj;
        
        conn.send({ type: 'build', r, c, buildType: type, isLast: (actionsLeft<=0) });
        updateUI(); render(); 
    }

    function checkResources(cost) {
        if (myResources.wood < cost.wood || myResources.stone < cost.stone || 
            myResources.metal < cost.metal || myResources.cedar < cost.cedar ||
            myResources.paper < cost.paper || myResources.gem < cost.gem || 
            myResources.coal < cost.coal) {
            alert(`–ù–ï –•–í–ê–¢–ê–ï–¢ –†–ï–°–£–†–°–û–í!`);
            return false;
        }
        return true;
    }

    function payResources(cost) {
        myResources.wood -= cost.wood;
        myResources.stone -= cost.stone;
        myResources.metal -= cost.metal;
        myResources.cedar -= cost.cedar;
        myResources.paper -= cost.paper;
        myResources.gem -= cost.gem;
        myResources.coal -= cost.coal;
    }

    function collectResources() {
        let produced = { w:0, s:0, m:0, c:0, p:0, f:0, g:0, cl:0, poly:0 };
        
        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                const p = state[r][c];
                if (p && p.color === playerColor) {
                    if (p.type === 'mine') { if (myResources.stone < 5) produced.s++; }
                    if (p.type === 'mine_t2') { 
                        if (myResources.stone < 5) produced.s++; 
                        if (myResources.metal < 5) produced.m++; 
                    }
                    if (p.type === 'mine_t3') {
                        if (myResources.stone < 5) produced.s++;
                        if (myResources.metal < 5) produced.m++;
                        if (myResources.gem < 5) produced.g++;
                    }

                    if (p.type === 'lumber') { if (myResources.wood < 5) produced.w++; }
                    if (p.type === 'lumber_t2') { 
                        if (myResources.wood < 5) produced.w++; 
                        if (myResources.cedar < 5) produced.c++; 
                    }
                    if (p.type === 'lumber_t3') {
                        if (myResources.wood < 5) produced.w++;
                        if (myResources.cedar < 5) produced.c++;
                        if (myResources.polymer < 5) produced.poly++;
                    }

                    if (p.type === 'furnace') {
                         if (myResources.cedar > 0 && myResources.coal < 5) {
                             myResources.cedar--;
                             produced.cl++;
                         }
                    }

                    if (p.type === 'farm') { if (myResources.food < 5) produced.f++; }
                    if (p.type === 'papermill') {
                        if (myResources.wood > 0 && myResources.paper < 5) {
                            myResources.wood--; 
                            produced.p++;
                        }
                    }
                }
            }
        }
        
        myResources.wood = Math.min(5, myResources.wood + produced.w);
        myResources.stone = Math.min(5, myResources.stone + produced.s);
        myResources.metal = Math.min(5, myResources.metal + produced.m);
        myResources.cedar = Math.min(5, myResources.cedar + produced.c);
        myResources.paper = Math.min(5, myResources.paper + produced.p);
        myResources.food = Math.min(5, myResources.food + produced.f);
        myResources.gem = Math.min(5, myResources.gem + produced.g);
        myResources.coal = Math.min(5, myResources.coal + produced.cl);
        myResources.polymer = Math.min(5, myResources.polymer + produced.poly);
    }

    function onCampClick(e, r, c) {
        e.stopPropagation();
        if (isBuildMode || actionsLeft < 1) return;
        
        if (confirm("–ù–ê–ù–Ø–¢–¨ –ü–ï–®–ö–£? (2 –ï–î–´, 1 –û–î)")) {
            if (myResources.food < 2) {
                alert("–ù–ï –•–í–ê–¢–ê–ï–¢ –ï–î–´!");
                return;
            }
            const dir = playerColor === 'w' ? -1 : 1;
            const targetR = r + dir;
            if (targetR < 0 || targetR >= rows || state[targetR][c]) {
                alert("–ú–ï–°–¢–û –í–´–°–ê–î–ö–ò –ó–ê–ù–Ø–¢–û!");
                return;
            }
            myResources.food -= 2;
            actionsLeft--;
            state[targetR][c] = { type: 'p', color: playerColor, moved: true, armor: 0 };
            conn.send({ type: 'transform', from: {r: r, c: c}, to: {r: targetR, c: c}, newType: 'p', isLast: (actionsLeft <= 0) });
            updateUI(); render();
        }
    }

    function isValidMove(fr, fc, tr, tc) {
        if (tr < 0 || tr >= rows || tc < 0 || tc >= cols) return false;

        const p = state[fr][fc]; 
        if (!p) return false;

        const dest = state[tr][tc];

        if (dest && dest.type === 'forge') return true;

        if (dest && dest.color === p.color) {
            if ((dest.type === 'academy' || dest.type === 'academy_t2') && p.type === 'p') {
                return true; 
            }
            return false; 
        }

        if (dest && isUpgradedUnit(dest) && p.type === 'p') return false;
        
        const dr = tr - fr, dc = tc - fc; 
        const adr = Math.abs(dr), adc = Math.abs(dc);
        const baseType = p.type.replace('_2', '');

        if (['b','r','q'].includes(baseType)) {
            if (!isPathClear(fr, fc, tr, tc)) return false;
        }

        switch(baseType) {
            case 'p':
                const dir = p.color === 'w' ? -1 : 1;
                if (dest && (dest.type === 'academy' || dest.type === 'academy_t2') && dest.color === p.color) return true;
                if (dc === 0 && !dest && dr === dir) return true;
                if (dc === 0 && !dest && !p.moved && dr === 2 * dir) {
                    if (!state[fr + dir][fc]) return true;
                }
                if (adc === 1 && dr === dir && dest && dest.color !== p.color) return true;
                return false;
            case 'n': return (adr === 2 && adc === 1) || (adr === 1 && adc === 2);
            case 'b': return adr === adc; 
            case 'r': return (dr === 0 || dc === 0); 
            case 'q': return (adr === adc || dr === 0 || dc === 0); 
            case 'k': return (adr <= 1 && adc <= 1); 
        }
        return false;
    }

    function isPathClear(fr, fc, tr, tc) {
        const stepR = Math.sign(tr - fr), stepC = Math.sign(tc - fc);
        let curR = fr + stepR, curC = fc + stepC;
        while (curR !== tr || curC !== tc) { 
            if (state[curR][curC]) return false; 
            curR += stepR; curC += stepC; 
        }
        return true;
    }

    function movePiece(fr, fc, tr, tc) {
        const piece = state[fr][fc];
        const dest = state[tr][tc];

        if (dest && (dest.type === 'academy' || dest.type === 'academy_t2') && dest.color === piece.color && piece.type === 'p') {
            openAcademyModal(fr, fc, tr, tc, dest.type === 'academy_t2');
            return;
        }

        if (dest && dest.type === 'forge') {
            if (dest.color === piece.color || !dest.color) { 
                if (piece.onForge) {
                    state[fr][fc] = { type: 'forge', color: piece.color };
                } else {
                    state[fr][fc] = null;
                }
                piece.onForge = true;
                piece.moved = true;
                state[tr][tc] = piece;

                actionsLeft--;
                conn.send({ type: 'move', from: {r:fr, c:fc}, to: {r:tr, c:tc}, isLast: (actionsLeft<=0), onForgeEnter: true });
                updateUI(); render();
                return;
            }
        }

        if (piece.onForge) {
            state[fr][fc] = { type: 'forge', color: piece.color };
            piece.onForge = false;
        } else {
            state[fr][fc] = null;
        }

        if (dest && dest.color !== piece.color) {
            if (dest.type.startsWith('fortress')) {
                if (dest.hp > 1) {
                    dest.hp--;
                    if (state[fr][fc] && state[fr][fc].type === 'forge') {
                        state[fr][fc] = piece; piece.onForge = true;
                    } else {
                        state[fr][fc] = piece; 
                    }
                    actionsLeft--;
                    conn.send({ type: 'attack_hit', r: tr, c: tc, hp: dest.hp, isLast: (actionsLeft<=0) });
                    updateUI(); render();
                    return;
                }
            }
            if (dest.armor > 0) {
                dest.armor--;
                if (state[fr][fc] && state[fr][fc].type === 'forge') {
                    state[fr][fc] = piece; piece.onForge = true;
                } else {
                    state[fr][fc] = piece;
                }
                actionsLeft--;
                conn.send({ type: 'attack_armor', r: tr, c: tc, armor: dest.armor, isLast: (actionsLeft<=0) });
                updateUI(); render();
                return;
            }
        }

        let isWinMove = (dest && dest.type === 'k');
        if (isWinMove) endGame(true);

        let costsAP = true;
        if (isUpgradedUnit(piece)) {
            if (!piece.freeMoveUsed) {
                costsAP = false;
                piece.freeMoveUsed = true; 
            }
        }

        state[tr][tc] = piece; 
        piece.moved = true; 
        
        if (costsAP) actionsLeft--;
        
        const endRow = playerColor === 'w' ? 0 : (rows - 1);
        if (piece.type === 'p' && tr === endRow && !isWinMove) {
            showPromotionModal(fr, fc, tr, tc); 
            return; 
        }

        conn.send({ 
            type: 'move', from: {r:fr, c:fc}, to: {r:tr, c:tc}, 
            isLast: (actionsLeft <= 0), win: isWinMove, 
            freeMoveUsed: !costsAP 
        });
        updateUI(); render();
    }

    function openAcademyModal(fr, fc, tr, tc, isT2) {
        pendingAcademy = { from: {r:fr, c:fc}, acad: {r:tr, c:tc} };
        const modal = document.getElementById('academy-modal');
        const stdContainer = document.getElementById('acad-std-options');
        const eliteContainer = document.getElementById('acad-elite-options');
        const eliteSection = document.getElementById('acad-elite-section');

        stdContainer.innerHTML = '';
        eliteContainer.innerHTML = '';

        const units = [{t:'n', i:'‚ôû'}, {t:'b', i:'‚ôù'}, {t:'r', i:'‚ôú'}];

        units.forEach(u => {
            const btn = document.createElement('div');
            btn.className = 'promo-btn';
            btn.innerHTML = `${u.i}<span class="cost">2 –ë–£–ú–ê–ì–ò</span>`;
            btn.onclick = () => finishAcademyRecruit(u.t, 2);
            stdContainer.appendChild(btn);
        });

        if (isT2) {
            eliteSection.classList.remove('hidden');
            units.forEach(u => {
                const btn = document.createElement('div');
                btn.className = 'promo-btn upgraded-offer';
                btn.innerHTML = `${u.i}<span class="cost" style="color:gold">5 –ë–£–ú–ê–ì–ò</span>`;
                btn.onclick = () => finishAcademyRecruit(u.t + '_2', 5); 
                eliteContainer.appendChild(btn);
            });
        } else {
            eliteSection.classList.add('hidden');
        }

        modal.classList.remove('hidden');
    }

    function finishAcademyRecruit(newType, paperCost) {
        if (actionsLeft < 1) {
             alert("–ù–ï–¢ –û–î –î–õ–Ø –û–ë–£–ß–ï–ù–ò–Ø!");
             return;
        }

        if (myResources.paper < paperCost) {
            alert(`–ù–ï –•–í–ê–¢–ê–ï–¢ –ë–£–ú–ê–ì–ò (–ù–£–ñ–ù–û ${paperCost})!`);
            return;
        }
        myResources.paper -= paperCost;

        const { from, acad } = pendingAcademy;
        const dir = playerColor === 'w' ? -1 : 1;
        const spawnR = acad.r + dir;
        const spawnC = acad.c;

        if (spawnR < 0 || spawnR >= rows || state[spawnR][spawnC]) {
            alert("–í–´–•–û–î –ò–ó –ê–ö–ê–î–ï–ú–ò–ò –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù!");
            closeModal('academy-modal');
            return;
        }

        state[from.r][from.c] = null;
        state[spawnR][spawnC] = { type: newType, color: playerColor, moved: true, freeMoveUsed: false, armor: 0 };
        
        actionsLeft--; 
        conn.send({ 
            type: 'transform', from: from, to: {r:spawnR, c:spawnC}, 
            newType: newType, isLast: (actionsLeft <= 0) 
        });
        
        closeModal('academy-modal');
        updateUI(); render();
    }

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    function showPromotionModal(fr, fc, tr, tc) {
        pendingMove = { fr, fc, tr, tc };
        const modal = document.getElementById('promotion-modal');
        const container = document.getElementById('promo-options-container');
        container.innerHTML = '';
        [{t:'q', i:'‚ôõ'}, {t:'r', i:'‚ôú'}, {t:'b', i:'‚ôù'}, {t:'n', i:'‚ôû'}].forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'promo-btn';
            btn.innerHTML = opt.i;
            btn.onclick = () => finishPromotion(opt.t);
            container.appendChild(btn);
        });
        modal.classList.remove('hidden');
    }

    function finishPromotion(newType) {
        document.getElementById('promotion-modal').classList.add('hidden');
        const { fr, fc, tr, tc } = pendingMove;
        state[tr][tc] = state[fr][fc]; state[tr][tc].type = newType; state[fr][fc] = null;
        actionsLeft--;
        conn.send({ type: 'move', from: {r:fr, c:fc}, to: {r:tr, c:tc}, isLast: (actionsLeft <= 0), win: false, promoteTo: newType });
        pendingMove = null; updateUI(); render();
    }

    function endGame(isWin) {
        gameOver = true;
        const modal = document.getElementById('victory-modal');
        const title = document.getElementById('victory-title');
        title.innerHTML = isWin ? '–ü–û–ë–ï–î–ê!' : '–ü–û–†–ê–ñ–ï–ù–ò–ï...';
        title.style.color = isWin ? '#2ecc71' : '#e74c3c';
        modal.classList.remove('hidden');
    }

    function updateUI() {
        const statusEl = document.getElementById('status');
        if (actionsLeft > 0) statusEl.textContent = `–¢–í–û–ô –•–û–î (${actionsLeft} –î.)`;
        else statusEl.textContent = "–•–û–î –ü–†–û–¢–ò–í–ù–ò–ö–ê...";
        
        if (isBuildMode) document.body.classList.add('build-mode');
        else document.body.classList.remove('build-mode');
        
        const hasHQ = hasSpecial(playerColor, 'hq');
        document.getElementById('btn-build-hq').classList.toggle('hidden-btn', hasHQ);

        if (conn && !isExpanded && isBuildMode) document.getElementById('btn-apogee').style.display = 'block';
    }

    window.onkeydown = (e) => {
        if ((e.key.toLowerCase() === 'b' || e.key.toLowerCase() === '–∏') && actionsLeft > 0) {
            toggleBuildMode();
        }
    };

    peer.on('open', id => document.getElementById('my-id').textContent = id);
    peer.on('error', err => {
        alert("–û–®–ò–ë–ö–ê –°–ï–¢–ò: " + err.type);
        document.getElementById('conn-status').innerText = "–û–®–ò–ë–ö–ê: " + err.type;
    });

    function connectToPeer() {
        const id = document.getElementById('peer-id').value;
        if(!id) return alert("–í–í–ï–î–ò–¢–ï ID –î–†–£–ì–ê!");
        document.getElementById('conn-status').innerText = "–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...";
        conn = peer.connect(id); playerColor = 'b'; setupConn();
    }
    peer.on('connection', c => { conn = c; playerColor = 'w'; actionsLeft = 1; setupConn(); });

    function setupConn() {
        conn.on('open', () => {
            document.getElementById('connection-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('connection-overlay').classList.add('hidden'), 500);

            if (!isExpanded) initBoard(); 
            updateUI();
            conn.on('data', d => {
                if (d.type === 'move') {
                    let movingPiece = state[d.from.r][d.from.c];
                    if (movingPiece && movingPiece.onForge) {
                         state[d.from.r][d.from.c] = { type: 'forge', color: movingPiece.color };
                    } else {
                         state[d.from.r][d.from.c] = null;
                    }
                    if (d.onForgeEnter) {
                         let pObj = movingPiece || {type: 'p', color: (playerColor==='w'?'b':'w')}; 
                         pObj.onForge = true;
                         pObj.moved = true;
                         if (d.promoteTo) pObj.type = d.promoteTo; 
                         state[d.to.r][d.to.c] = pObj;
                    } else {
                         let pObj = movingPiece || { type: 'p', color: (playerColor==='w'?'b':'w') }; 
                         pObj.moved = true;
                         if (d.promoteTo) pObj.type = d.promoteTo;
                         state[d.to.r][d.to.c] = pObj;
                    }
                    if (d.win) endGame(false);
                } else if (d.type === 'attack_hit') {
                    if (state[d.r][d.c]) state[d.r][d.c].hp = d.hp;
                } else if (d.type === 'attack_armor') {
                    if (state[d.r][d.c]) state[d.r][d.c].armor = d.armor;
                } else if (d.type === 'forge_armor') {
                    if (state[d.r][d.c]) state[d.r][d.c].armor = (state[d.r][d.c].armor || 0) + 1;
                } else if (d.type === 'transform') {
                    if (state[d.from.r][d.from.c] && state[d.from.r][d.from.c].type === 'p') {
                        state[d.from.r][d.from.c] = null;
                    } 
                    state[d.to.r][d.to.c] = { type: d.newType, color: playerColor === 'w' ? 'b' : 'w', moved: true, armor: 0 };
                } else if (d.type === 'build') {
                    let obj = { type: d.buildType, color: playerColor === 'w' ? 'b' : 'w' };
                    if (d.buildType === 'fortress') obj.hp = FORTRESS_HP['fortress'];
                    state[d.r][d.c] = obj;
                } else if (d.type === 'upgrade') {
                    state[d.r][d.c].type = d.newType;
                    if (d.newType.startsWith('fortress')) state[d.r][d.c].hp = FORTRESS_HP[d.newType];
                } else if (d.type === 'demolish') {
                    if (state[d.r][d.c] && state[d.r][d.c].onForge) {
                        state[d.r][d.c].onForge = false;
                    } else {
                        state[d.r][d.c] = null;
                    }
                } else if (d.type === 'apogee_trigger') {
                    triggerExpansion();
                }

                if (d.isLast) turnEndLogic();
                render(); updateUI();
            });
        });
        
        conn.on('error', err => {
            alert("–†–ê–ó–†–´–í –°–û–ï–î–ò–ù–ï–ù–ò–Ø!");
        });
    }

    function turnEndLogic() {
        actionsLeft = hasSpecial(playerColor, 'hq') ? 2 : 1; 
        state.flat().forEach(p => { if (p) p.freeMoveUsed = false; });
        collectResources();
    }

    function onPiecePointerDown(e, fr, fc) {
        if (gameOver || !conn || actionsLeft <= 0 || isBuildMode) {
             if (!isBuildMode && state[fr][fc] && state[fr][fc].onForge && state[fr][fc].color === playerColor) {
                 selectedPiece = {r: fr, c: fc};
                 render(); 
             }
             return;
        }
        if (state[fr][fc] && state[fr][fc].type === 'camp') return;
        const p = state[fr][fc];
        if (!p || p.color !== playerColor) return;
        
        selectedPiece = {r: fr, c: fc}; 
        
        dragState.isBuildingDrag = false;
        dragState.from = { r: fr, c: fc };
        const baseType = p.type.replace('_2', '');
        initDrag(e, `url(${PIECE_URLS[p.color + baseType]})`);
    }

    function onSidebarPointerDown(e, type) {
        if (gameOver || !conn || actionsLeft <= 0 || !isBuildMode) return;
        dragState.isBuildingDrag = true;
        dragState.from = { type: type };
        initDrag(e, null, BUILDING_ICONS[type] || BUILDING_ICONS[type.replace('_t2','').replace('_t3','')]);
    }

    function initDrag(e, bgImage, icon) {
        dragState.pointerId = e.pointerId;
        dragState.startX = e.clientX; dragState.startY = e.clientY;
        dragState.started = false;
        
        const clone = document.createElement('div');
        clone.className = 'dragging-clone';
        if (bgImage) clone.style.backgroundImage = bgImage;
        if (icon) clone.innerHTML = icon;
        dragState.cloneEl = clone;
        
        document.body.appendChild(dragState.cloneEl); 
        dragState.cloneEl.style.left = `${e.clientX}px`;
        dragState.cloneEl.style.top = `${e.clientY}px`;
        dragState.cloneEl.style.display = 'none';

        document.addEventListener('pointermove', onDocumentPointerMove);
        document.addEventListener('pointerup', onDocumentPointerUp);
        e.preventDefault();
    }

    function onDocumentPointerMove(e) {
        if (e.pointerId !== dragState.pointerId) return;
        
        if (!dragState.started && Math.hypot(e.clientX - dragState.startX, e.clientY - dragState.startY) > 5) {
            dragState.started = true;
            dragState.cloneEl.style.display = 'flex';
        }
        
        if (dragState.started) {
            dragState.cloneEl.style.left = `${e.clientX}px`;
            dragState.cloneEl.style.top = `${e.clientY}px`;
            updateHoverHighlight(e.clientX, e.clientY);
        }
        e.preventDefault();
    }

    function onDocumentPointerUp(e) {
        if (e.pointerId !== dragState.pointerId) return;
        
        if (dragState.started) {
            const target = getSquareFromPoint(e.clientX, e.clientY);
            if (target) {
                if (dragState.isBuildingDrag) {
                    if (isNearOwnPiece(target.r, target.c)) {
                        buildSomething(target.r, target.c, dragState.from.type);
                    } else if (dragState.from.type === 'demolish') {
                        buildSomething(target.r, target.c, 'demolish');
                    } else {
                        alert("–°–¢–†–û–ò–¢–¨ –ú–û–ñ–ù–û –¢–û–õ–¨–ö–û –†–Ø–î–û–ú –° –°–û–Æ–ó–ù–´–ú–ò –Æ–ù–ò–¢–ê–ú–ò.");
                    }
                } else {
                    if (isValidMove(dragState.from.r, dragState.from.c, target.r, target.c)) {
                        movePiece(dragState.from.r, dragState.from.c, target.r, target.c);
                    }
                }
            }
            cleanupDrag();
        }
        document.removeEventListener('pointermove', onDocumentPointerMove);
        document.removeEventListener('pointerup', onDocumentPointerUp);
    }

    function isNearOwnPiece(r, c) {
        if (state[r][c] && state[r][c].color === playerColor && (dragState.from.type.endsWith('_t2') || dragState.from.type.endsWith('_t3'))) return true;
        if (state[r][c]) return false; 
        
        const targetIsFog = isFog(r, c);
        for(let dr = -1; dr <= 1; dr++) {
            for(let dc = -1; dc <= 1; dc++) {
                const nr = r + dr, nc = c + dc;
                if (nr >= 0 && nr < rows && nc >= 0 && nc < cols) {
                    const neighbor = state[nr][nc];
                    if (neighbor && neighbor.color === playerColor && !BUILDINGS.includes(neighbor.type)) {
                        if (targetIsFog === isFog(nr, nc)) return true;
                    }
                }
            }
        }
        return false;
    }

    function cleanupDrag() {
        if (dragState.cloneEl && dragState.cloneEl.parentElement) dragState.cloneEl.parentElement.removeChild(dragState.cloneEl);
        if (dragState.lastHover) dragState.lastHover.classList.remove('drag-over');
        dragState.lastHover = null;
    }

    function updateHoverHighlight(x, y) {
        if(dragState.cloneEl) dragState.cloneEl.style.display = 'none';
        const el = document.elementFromPoint(x, y);
        if(dragState.cloneEl) dragState.cloneEl.style.display = 'flex';
        
        const sq = el?.closest('.square');
        if (dragState.lastHover && dragState.lastHover !== sq) dragState.lastHover.classList.remove('drag-over');
        if (sq) {
            sq.classList.add('drag-over');
            dragState.lastHover = sq;
        }
    }

    function getSquareFromPoint(x, y) {
        if(dragState.cloneEl) dragState.cloneEl.style.display = 'none';
        const el = document.elementFromPoint(x, y);
        if(dragState.cloneEl) dragState.cloneEl.style.display = 'flex';
        
        const sq = el?.closest('.square');
        if (!sq) return null;
        
        const idx = Array.from(document.getElementById('board').children).indexOf(sq);
        if (idx === -1) return null;
        const visualRow = Math.floor(idx / cols);
        const c = idx % cols;
        const r = playerColor === 'b' ? (rows - 1) - visualRow : visualRow;
        return { r, c };
    }
</script>
</body>
</html>